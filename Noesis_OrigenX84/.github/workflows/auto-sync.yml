name: ğŸŒŒ Noesis Auto-Sync CÃ³smico

on:
  # Ejecutar cada 6 horas
  schedule:
    - cron: '0 */6 * * *'
  
  # Ejecutar cuando hay push a main
  push:
    branches: [ main ]
  
  # Ejecutar cuando hay pull request
  pull_request:
    branches: [ main ]
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      sync_message:
        description: 'Mensaje personalizado para el commit'
        required: false
        default: 'ğŸŒŒ SincronizaciÃ³n AutomÃ¡tica NoÃ©sica'

jobs:
  sync-and-optimize:
    name: ğŸ”„ SincronizaciÃ³n y OptimizaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del repositorio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install gitpython requests pytz
    
    - name: ğŸ”§ Configurar Git
      run: |
        git config --global user.name "Noesis Bot ğŸ¤–"
        git config --global user.email "noesis-bot@github.com"
    
    - name: ğŸ§¹ Limpiar y optimizar repositorio
      run: |
        echo "ğŸ§¹ Limpiando archivos temporales..."
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        find . -name ".DS_Store" -delete 2>/dev/null || true
        
        echo "ğŸ“Š Analizando tamaÃ±o del repositorio..."
        du -sh .git
        
        if [ $(du -s .git | cut -f1) -gt 104857600 ]; then
          echo "âš¡ Optimizando repositorio (>100MB)..."
          git gc --aggressive --prune=now
          git repack -a -d -f --depth=250 --window=250
        fi
    
    - name: ğŸ” AnÃ¡lisis de cÃ³digo y seguridad
      continue-on-error: true
      run: |
        echo "ğŸ” Analizando archivos Python..."
        find . -name "*.py" -type f | wc -l
        
        echo "ğŸ” Verificando archivos sensibles..."
        if grep -r "password\|secret\|api_key" --include="*.py" --include="*.js" . 2>/dev/null | grep -v "^Binary"; then
          echo "âš ï¸ ADVERTENCIA: Posibles credenciales encontradas"
        fi
    
    - name: ğŸ“Š Generar mÃ©tricas del repositorio
      run: |
        cat > .noesis_metrics.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "total_files": $(find . -type f | wc -l),
          "python_files": $(find . -name "*.py" -type f | wc -l),
          "total_commits": $(git rev-list --count HEAD),
          "contributors": $(git shortlog -sn | wc -l),
          "last_sync": "$(date)",
          "workflow_run": "${{ github.run_number }}",
          "triggered_by": "${{ github.event_name }}"
        }
        EOF
    
    - name: ğŸ¤– Generar mensaje de commit inteligente
      id: commit_message
      run: |
        python3 << 'EOF'
        import random
        import datetime
        import os
        
        # Emojis temÃ¡ticos
        emojis = ["ğŸŒŒ", "ğŸ”®", "âš¡", "ğŸ¯", "ğŸš€", "âœ¨", "ğŸ”¥", "ğŸ’", "ğŸŒŸ", "ğŸ›¸", "ğŸ§¬", "ğŸ­", "ğŸŒ€", "ğŸ”¯"]
        emoji = random.choice(emojis)
        
        # Contexto del evento
        event = os.environ.get('GITHUB_EVENT_NAME', 'manual')
        custom_msg = "${{ github.event.inputs.sync_message }}"
        
        # Generar mensaje basado en contexto
        if custom_msg and custom_msg != "ğŸŒŒ SincronizaciÃ³n AutomÃ¡tica NoÃ©sica":
            message = custom_msg
        elif event == "schedule":
            hour = datetime.datetime.now().hour
            if hour < 6:
                message = f"{emoji} SincronizaciÃ³n Nocturna CÃ³smica"
            elif hour < 12:
                message = f"{emoji} Despertar Matutino NoÃ©sico"
            elif hour < 18:
                message = f"{emoji} ArmonizaciÃ³n Vespertina"
            else:
                message = f"{emoji} Convergencia Nocturna"
        elif event == "push":
            message = f"{emoji} EvoluciÃ³n Continua del CÃ³digo"
        elif event == "pull_request":
            message = f"{emoji} FusiÃ³n de Realidades Paralelas"
        else:
            message = f"{emoji} ActualizaciÃ³n NoÃ©sica AutomÃ¡tica"
        
        # Agregar timestamp
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
        full_message = f"{message} | {timestamp} | Run #{os.environ.get('GITHUB_RUN_NUMBER', '0')}"
        
        print(f"COMMIT_MSG={full_message}")
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"message={full_message}\n")
        EOF
    
    - name: ğŸ’¾ Commit y Push cambios
      run: |
        # Verificar si hay cambios
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ“ Cambios detectados, procediendo con commit..."
          git add .
          git commit -m "${{ steps.commit_message.outputs.message }}"
          git push origin main
          echo "âœ… SincronizaciÃ³n completada"
        else
          echo "â„¹ï¸ No hay cambios para sincronizar"
        fi
    
    - name: ğŸ“¢ NotificaciÃ³n de estado
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Workflow completado exitosamente"
        else
          echo "âŒ Workflow fallÃ³ - Revisar logs"
        fi

  security-scan:
    name: ğŸ” Escaneo de Seguridad
    runs-on: ubuntu-latest
    needs: sync-and-optimize
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ” Ejecutar anÃ¡lisis de seguridad
      uses: github/super-linter@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_PYTHON: true
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_JSON: true
        VALIDATE_YAML: true
        VALIDATE_BASH: true
    
    - name: ğŸ›¡ï¸ Escaneo de vulnerabilidades
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'

  create-release:
    name: ğŸ·ï¸ Crear Release AutomÃ¡tico
    runs-on: ubuntu-latest
    needs: [sync-and-optimize, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ·ï¸ Generar versiÃ³n
      id: version
      run: |
        # Formato: v1.YYYY.MMDD.RUN
        VERSION="v1.$(date +%Y).$(date +%m%d).${{ github.run_number }}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ Nueva versiÃ³n: $VERSION"
    
    - name: ğŸ“¦ Crear Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: "ğŸŒŒ Noesis ${{ steps.version.outputs.VERSION }}"
        body: |
          ## ğŸŒŒ Release AutomÃ¡tico NoÃ©sico
          
          ### ğŸ“Š EstadÃ­sticas
          - **VersiÃ³n**: ${{ steps.version.outputs.VERSION }}
          - **Fecha**: $(date)
          - **Commit**: ${{ github.sha }}
          - **Workflow Run**: #${{ github.run_number }}
          
          ### ğŸ”„ Cambios
          - SincronizaciÃ³n automÃ¡tica completada
          - OptimizaciÃ³n del repositorio
          - AnÃ¡lisis de seguridad ejecutado
          
          ### ğŸš€ Mejoras continuas
          El sistema Noesis evoluciona constantemente mediante sincronizaciÃ³n automÃ¡tica.
          
          ---
          *Generado automÃ¡ticamente por el Modo Dios CÃ³smico* ğŸ›¸
        draft: false
        prerelease: false

  cleanup-old-workflows:
    name: ğŸ§¹ Limpieza de Workflows Antiguos
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ—‘ï¸ Eliminar runs antiguos
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 30
        keep_minimum_runs: 10
